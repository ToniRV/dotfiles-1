#!/bin/bash

run_brew() {

    # Check for Homebrew
    if type_exists 'brew'; then
        e_header "Updating Homebrew"
        # Use the latest version of Homebrew
        brew update
        [[ $? ]] && e_success "Done"

        e_header "Updating any existing Homebrew formulae"
        # Upgrade any already-installed formulae
        brew upgrade
        [[ $? ]] && e_success "Done"

        e_header "Taping Homebrew"

        while read line; do
           brew tap "$line"
        done < "$DOTFILES_DIRECTORY"/installed/Tapfile
        [[ $? ]] && e_success "Done"

        e_header "Checking status of desired Homebrew formulae"
        local list_formulae
        local -a missing_formulae=(
            'astyle'
            'bash'
            'bash-completion'
            'battery'
            'bundler-completion'
            'cmake'
            'colordiff'
            'composer'
            'coreutils'
            'ctags'
            'django-completion'
            'dos2unix'
            'ffmpeg'
            'findutils'
            'fontconfig'
            'gcc'
            'gem-completion'
            'git'
            'go'
            'grunt-completion'
            'heroku-toolbelt'
            'rsync'
            'htop-osx'
            'imagemagick'
            'jenv'
            'latex2html'
            'libspatialite'
            'mcrypt'
            'mongodb'
            'moreutils'
            'mysql'
            'ngrep'
            'ngrok'
            'nmap'
            'node'
            'open-ocd'
            'openssl'
            'pip-completion'
            'pkg-config'
            'postgis'
            'postgresql'
            'pyqt'
            'python'
            'python3'
            'qemu'
            'qt5'
            'rails-completion'
            'rake-completion'
            'rbenv'
            'readline'
            'reattach-to-user-namespace'
            'rename'
            'ruby'
            'ruby-completion'
            'sdcc'
            'spim'
            'sqlite'
            'ssh-copy-id'
            'subversion'
            'tmux'
            'tmuxinator-completion'
            'tor'
            'torsocks'
            'tree'
            'unar'
            'unrar'
            'v8'
            'vagrant-completion'
            'vim --override-system-vi'
            'webkit2png'
            'wget --with-iri'
            'wireshark'
        )

        if [[ "$missing_formulae" ]]; then
            # Convert the array of missing formula into a list of space-separate strings
            list_formulae=$( printf "%s " "${missing_formulae[@]}" )

            e_header "Installing missing Homebrew formulae"
            # Install all missing formulae
            brew install $list_formulae

            [[ $? ]] && e_success "Done"
        fi

        # Remove outdated versions from the Cellar
        brew cleanup

        # Ask before installing Brewfile and Caskfile
        seek_confirmation "Do you want to install all formulae from Brewfile ?"

        if is_confirmed; then
            brew install $(cat "$DOTFILES_DIRECTORY"/installed/Brewfile | tr -s '\n' ' ')
            [[ $? ]] && e_success "Done"
        else
            e_underline "Skipped Brewfile"
        fi

        seek_confirmation "Do you want to install all formulae from Caskfile ?"

        if is_confirmed; then
            brew cask install $(cat "$DOTFILES_DIRECTORY"/installed/Caskfile | tr -s '\n' ' ')
            [[ $? ]] && e_success "Done"
        else
            e_underline "Skipped Caskfile"
        fi
    else
        printf "\n"
        e_error "Error: Homebrew not found."
        printf "Aborting...\n"
        exit
    fi

}
